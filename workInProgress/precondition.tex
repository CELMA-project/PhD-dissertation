\section{Preconditioning}
%
First we linearize in a way such that only linear terms of evolving variables comes into play.
Also, resistivity and diffusion neglected (say that these are slow)

\subsection{Linearize evolving variables}
%
\begin{align*}
 \partial_t n
 =&
 -\frac{1}{J}\L\{\phi,n\R\}
 +\frac{\nu_{ei}}{\mu} \grad_\perp^2 n
 -\partial_\| \L(u_{e,\|}n\R)
\\
%
%
%
\partial_t u_{e,\|}
 =&
 -\frac{1}{J}\L\{\phi,u_{e,\|}\R\}
 - u_{e,\|} \partial_\| u_{e,\|}
 + \mu \partial_\| \phi
 - \mu \frac{T_e }{n}\partial_\|   n
  %
 - 0.51 \nu_{ei} \L(u_{e,\|}-u_{i,\|}\R)
\\
%
%
%
\partial_t u_{i,\|}
 =&
 -\frac{1}{J}\L\{\phi,u_{i,\|}\R\}
 - u_{i,\|} \partial_\| u_{i,\|}
 - \partial_\|\phi
  %
 - \frac{ 0.51 \nu_{ei} }{ \mu } \L(u_{i,\|}-u_{e,\|}\R)
\\
%
%
%
  \partial_t \Om^D
  =&
  - \div \L( \ve{u}_E\cdot\nabla \L[\frac{\grad_\perp \phi}{B}n \R] \R)
  - \partial_\|\div \L( u_{i,\|}n \frac{\grad_\perp \phi}{B}\R)
 %
 + \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
%
Neglect resistivities and diffusivities, and for now also hard-core terms
%
\begin{align*}
 \partial_t n
 =&
 -\frac{1}{J}\L\{\phi,n\R\}
 -\partial_\| \L(u_{e,\|}n\R)
\\
%
%
%
\partial_t u_{e,\|}
 =&
 -\frac{1}{J}\L\{\phi,u_{e,\|}\R\}
 - u_{e,\|} \partial_\| u_{e,\|}
 + \mu \partial_\| \phi
 - \mu \frac{T_e}{n}\partial_\|  n
\\
%
%
%
\partial_t u_{i,\|}
 =&
 -\frac{1}{J}\L\{\phi,u_{i,\|}\R\}
 - u_{i,\|} \partial_\| u_{i,\|}
 - \partial_\|\phi
\\
%
%
%
  \partial_t \Om^D
  =&
  \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
%
by using Boussinesq, we have that $\Om^D\simeq\Om=\grad_\perp^2\phi$.
This means that $\phi\simeq\grad_\perp^{-2}\Om^D$
%
\begin{align*}
 \partial_t n
 =&
 -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,n\R\}
 -\partial_\| \L(u_{e,\|}n\R)
\\
%
%
%
\partial_t u_{e,\|}
 =&
 -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,u_{e,\|}\R\}
 - u_{e,\|} \partial_\| u_{e,\|}
 + \mu \partial_\| \phi
 - \mu \frac{T_e  }{n}\partial_\|  n
\\
%
%
%
\partial_t u_{i,\|}
 =&
 -\frac{1}{J}\L\{\phi,u_{i,\|}\R\}
 - u_{i,\|} \partial_\| u_{i,\|}
 - \partial_\|\grad_\perp^{-2}\Om^D
\\
%
%
%
  \partial_t \Om^D
  =&
  \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
%
As a first approximation, we neglect the non-linear terms
%
\begin{align*}
 \partial_t n
 =&
 -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,n\R\}
\\
%
%
%
\partial_t u_{e,\|}
 =&
 -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,u_{e,\|}\R\}
 + \mu \partial_\| \grad_\perp^{-2}\Om^D
\\
%
%
%
\partial_t u_{i,\|}
 =&
 -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D, u_{i,\|}\R\}
 - \partial_\|\grad_\perp^{-2}\Om^D
\\
%
%
%
  \partial_t \Om^D
  =&
  \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
\subsection{Finding the Jacobian}
%
Recall that we have
%
\begin{align*}
-\frac{1}{J}\L\{\phi,f\R\}
= \ve{u}_{\ve{E}\times\ve{B}}\cdot\grad f
= -\frac{\grad\phi\times\ve{b}}{B}\cdot\grad_\perp f
= \grad_\perp f\cdot\frac{\ve{b}\times\grad_\perp\phi}{B}
\simeq \grad_\perp f\cdot\frac{\ve{b}\times\grad_\perp\grad_\perp^{-2}\Om^D}{B}
\end{align*}
%
Dens
\begin{align*}
 \parti{ \partial_t n }{n} =& -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\} \\
 %
 \parti{ \partial_t n }{u_{e,\|}} =& 0 \\
 %
 \parti{ \partial_t n }{u_{i,\|}} =& 0 \\
 %
 \parti{ \partial_t n }{\Om^D} =& -\frac{1}{J}\L\{\grad_\perp^{-2},n\R\}
\end{align*}
Par el mom
\begin{align*}
    \parti{ \partial_t u_{e,\|} }{ n } =& 0\\
    %
    \parti{ \partial_t u_{e,\|} }{u_{e,\|}} =&
    -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}\\
    %
    \parti{ \partial_t u_{e,\|} }{ u_{i,\| } }=& 0\\
    %
    \parti{ \partial_t u_{e,\|} }{ \Om^D } =&
    -\frac{1}{J}\L\{\grad_\perp^{-2},u_{e,\|}\R\} + \mu \partial_\|
    \grad_\perp^{-2}
\end{align*}
Par i mom
\begin{align*}
    \parti{\partial_t u_{i,\|}}{n} =& 0 \\
%
\parti{\partial_t u_{i,\|}}{u_{e,\|}} =& 0\\
%
    \parti{\partial_t u_{i,\|}}{u_{i,\|}} =&
    -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\} \\
%
    \parti{\partial_t u_{i,\|}}{\Om^D} =&
    -\frac{1}{J}\L\{\grad_\perp^{-2},u_{i,\|}\R\} -
    \partial_\|\grad_\perp^{-2}
\end{align*}
Vorticity
\begin{align*}
  \parti{\partial_t \Om^D}{n} =&
  \partial_\| \L(u_{i,\|} - u_{e,\|} \R)
  \\
  %
  \parti{\partial_t \Om^D}{u_{e,\|}} =&
  \partial_\| \L(nu_{i,\|} \R)
  \\
  %
  \parti{\partial_t \Om^D}{u_{i,\|}} =&
  -\partial_\| \L(nu_{e,\|} \R)
  \\
  %
  \parti{\partial_t \Om^D}{\Om^D} =&
  0
\end{align*}
Jacobian
\begin{align*}
    J &= \parti{\ve{f}}{\ve{u}}\\
    &=
    \begin{bmatrix}
        -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & 0
        & 0
        & -\frac{1}{J}\L\{\grad_\perp^{-2},n\R\}
        \\
        %
        %
        0
        & -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & 0
        & -\frac{1}{J}\L\{\grad_\perp^{-2},u_{e,\|}\R\}
          +\mu \partial_\| \grad_\perp^{-2}
        \\
        %
        %
        0
        & 0
        & -\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & -\frac{1}{J}\L\{\grad_\perp^{-2},u_{i,\|}\R\} -
            \partial_\|\grad_\perp^{-2}
        \\
        %
        %
        \partial_\| \L(u_{i,\|} - u_{e,\|} \R)
        & \partial_\| \L(nu_{i,\|} \R)
        & -\partial_\| \L(nu_{e,\|} \R)
        & 0
    \end{bmatrix}
\end{align*}
%

% FIXME: See time stepping

Equation $28$ in Knoll paper: Need to know inverse of preconditioner
Approximate inverse of $A=\L( \mathbb{I} - \gamma\mathbb{J}\R)$ above.
Have that
%
\begin{align*}
\mathbb{I} - \gamma\mathbb{J} =
    \begin{bmatrix}
        1+\gamma\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & 0
        & 0
        & \gamma\frac{1}{J}\L\{\grad_\perp^{-2},n\R\}
        \\
        %
        %
        0
        &1+ \gamma\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & 0
        & \gamma\frac{1}{J}\L\{\grad_\perp^{-2},u_{e,\|}\R\}
          -\gamma\mu \partial_\| \grad_\perp^{-2}
        \\
        %
        %
        0
        & 0
        & 1+\gamma\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & \gamma\frac{1}{J}\L\{\grad_\perp^{-2},u_{i,\|}\R\}
        + \gamma\partial_\|\grad_\perp^{-2}
        \\
        %
        %
        -\gamma\partial_\| \L(u_{i,\|} - u_{e,\|} \R)
        & -\gamma\partial_\| \L(nu_{i,\|} \R)
        & \gamma\partial_\| \L(nu_{e,\|} \R)
        & 1
    \end{bmatrix}
\end{align*}
%
Have that
%
\begin{align*}
    M =&
    \begin{bmatrix}
        1+\gamma\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & 0
        & 0
        \\
        %
        %
        0
        &1+ \gamma\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
        & 0
        \\
        %
        %
        0
        & 0
        & 1+\gamma\frac{1}{J}\L\{\grad_\perp^{-2}\Om^D,\R\}
    \end{bmatrix}
    \\
    %
    L = &
    \begin{bmatrix}
        -\gamma\partial_\| \L(u_{i,\|} - u_{e,\|} \R)
        & -\gamma\partial_\| \L(nu_{i,\|} \R)
        & \gamma\partial_\| \L(nu_{e,\|} \R)
    \end{bmatrix}
    \\
    %
    U =&
    \begin{bmatrix}
        \gamma\frac{1}{J}\L\{\grad_\perp^{-2},n\R\}
        \\
        %
        %
        \gamma\frac{1}{J}\L\{\grad_\perp^{-2},u_{e,\|}\R\}
          -\gamma\mu \partial_\| \grad_\perp^{-2}
        \\
        %
        %
        \gamma\frac{1}{J}\L\{\grad_\perp^{-2},u_{i,\|}\R\}
        + \gamma\partial_\|\grad_\perp^{-2}
    \end{bmatrix}
    \\
    %
    L = &
    \begin{bmatrix}
        1
    \end{bmatrix}
\end{align*}
%
Block decomposition
%
\begin{align*}
    \begin{bmatrix}
        M & U \\
        L & D
    \end{bmatrix}
    =&
    \begin{bmatrix}
        I & 0 \\
        L M^{-1} & I
    \end{bmatrix}
    \begin{bmatrix}
        M & 0 \\
        0 & D-L M^{-1} U
    \end{bmatrix}
    \begin{bmatrix}
        I & M^{-1} U \\
        0 & I
    \end{bmatrix}
    \\
     \begin{bmatrix}
        M & U \\
        L & D
    \end{bmatrix}
    ^{-1}
    =&
    \L(
    \begin{bmatrix}
        I & 0 \\
        L M^{-1} & I
    \end{bmatrix}
    \begin{bmatrix}
        M & 0 \\
        0 & D-L M^{-1} U
    \end{bmatrix}
    \begin{bmatrix}
        I & M^{-1} U \\
        0 & I
    \end{bmatrix}
    \R)^{-1}
    \\
     \begin{bmatrix}
        M & U \\
        L & D
    \end{bmatrix}
    ^{-1}
    =&
    \begin{bmatrix}
        I & M^{-1} U \\
        0 & I
    \end{bmatrix}
    ^{-1}
    \begin{bmatrix}
        M & 0 \\
        0 & D-L M^{-1} U
    \end{bmatrix}
    ^{-1}
    \begin{bmatrix}
        I & 0 \\
        L M^{-1} & I
    \end{bmatrix}
    ^{-1}
    \\
     \begin{bmatrix}
        M & U \\
        L & D
    \end{bmatrix}
    ^{-1}
    =&
    \begin{bmatrix}
        I & -M^{-1} U\\
        0 & I
    \end{bmatrix}
    \begin{bmatrix}
        M^{-1} & 0 \\
        0 & (D-L M^{-1} U)^{-1}
    \end{bmatrix}
    \begin{bmatrix}
        I & 0 \\
        -L M^{-1} & I
    \end{bmatrix}
\end{align*}
%
Have that $\|\ve{b}\|=1$, so \ldots cannot really do anything there
But
%
\begin{align*}
    \grad_\perp f\cdot\frac{\ve{b}\times\grad_\perp\grad_\perp^{-2}\Om^D}{B}
    =& \grad_\perp f\cdot\frac{\ve{b}\times\grad_\perp\phi}{B}
\end{align*}
%
So need somehow to invert the $E\times B$ advection

\section{Longer Lz}
%
Lz = 10 rhos in simulation

Lz = 100 rhos in simulations

As physical length of machine does not increase, this means rhos must decrease, which can happen when $B$ increases

\section{Only parallel}
%
But allow a radial gradient of $\phi$ in $\rho$.
This means that all Arakawa brackets become zero.

\section{Stuff from first attempt}
%
Assume no background gradients. Use that $\ve{u}_E\cdot\nabla \propto \frac{1}{J}\{\phi,\cdot\}$, and that
%
\begin{align*}
  \partial_\|\div \L( u_{i,\|}n \frac{\grad_\perp \phi}{B}\R)
  =&
  \partial_\|\L(\frac{\grad_\perp \phi}{B}\cdot\grad \L[ u_{i,\|}n \R]\R)
  +
  \partial_\|\L(u_{i,\|}n  \frac{\grad_\perp^2 \phi}{B}\R)
  \\
  =&
  %
  u_{i,\|}n \partial_\|\L(\frac{\grad_\perp^2 \phi}{B}\R)
  +
  \frac{\grad_\perp^2 \phi}{B} \partial_\|\L(u_{i,\|}n  \R)
  \\
  =&
  %
  u_{i,\|}n \partial_\|\L(\frac{\grad_\perp^2 \phi}{B}\R)
\end{align*}
%
which gives
%
\begin{align*}
\Om^D =&
n_0\frac{\grad_\perp^2\phi}{B}
\\
%
%
%
\partial_t \ln(n)
=&
 +\frac{\nu_{ei}}{\mu}
   \grad_\perp^2 \ln(n)
  %
- \partial_\|u_{e,\|}
- u_{e,\|,0} \partial_\| \ln(n)
\\
%
%
%
\partial_t u_{e,\|}
 =&
 - u_{e,\|,0} \partial_\| u_{e,\|}
 + \mu \partial_\| \L(\phi - T_e  \ln(n)\R)
  %
 - 0.51 \nu_{ei} \L(u_{e,\|}-u_{i,\|}\R)
\\
%
%
%
\partial_t u_{i,\|}
 =&
 - u_{i,\|,0} \partial_\| u_{i,\|}
 - \partial_\|\phi
  %
 - \frac{ 0.51 \nu_{ei} }{ \mu } \L(u_{i,\|}-u_{e,\|}\R)
\\
%
%
%
  \partial_t \Om^D
  =&
  - u_{i,\|,0}n_0 \L(\frac{\grad_\perp^2 \partial_\| \phi}{B}\R)
 %
 + \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
%
Assume no background flow
%
\begin{align*}
\Om^D =&
n_0\frac{\grad_\perp^2\phi}{B}
\\
%
%
%
\partial_t \ln(n)
=&
 \frac{\nu_{ei}}{\mu}
   \grad_\perp^2 \ln(n)
  %
- \partial_\|u_{e,\|}
\\
%
%
%
\partial_t u_{e,\|}
 =&
 \mu \partial_\| \L(\phi - T_e  \ln(n)\R)
  %
 - 0.51 \nu_{ei} \L(u_{e,\|}-u_{i,\|}\R)
\\
%
%
%
\partial_t u_{i,\|}
 =&
 - \partial_\|\phi
  %
 - \frac{ 0.51 \nu_{ei} }{ \mu } \L(u_{i,\|}-u_{e,\|}\R)
\\
%
%
%
  \partial_t \Om^D
  =&
 \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
%
Notice in the case when the velocities are set equal to each other, the evolution of the parallel velocities of the two species differs except when $\phi = \frac{T_e\ln(n)}{1+\frac{1}{\mu}}$....

Alternative approach:
Assume just parallel gradients
%
\begin{align*}
\Om^D =&
0
\\
%
%
%
\partial_t \ln(n)
=&
- \partial_\|u_{e,\|}
\\
%
%
%
\partial_t u_{e,\|}
 =&
 \mu \partial_\| \L(\phi - T_e  \ln(n)\R)
  %
 - 0.51 \nu_{ei} \L(u_{e,\|}-u_{i,\|}\R)
\\
%
%
%
\partial_t u_{i,\|}
 =&
 - \partial_\|\phi
  %
 - \frac{ 0.51 \nu_{ei} }{ \mu } \L(u_{i,\|}-u_{e,\|}\R)
\\
%
%
%
 0
  =&
 \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
\end{align*}
%
which gives
%
\begin{align*}
    \partial_t n
=&
- n\partial_\|u_{e,\|}
\\
-i\om n
=&
- nik_\|u_{e,\|}
\\
\om
=&
k_\|u_{e,\|}
\end{align*}

\begin{align*}
 0
  =&
 \partial_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
 \\
 0
  =&
  k_\| \L(n\L[ u_{i,\|} - u_{e,\|} \R]\R)
 \\
 u_{e,\|}
  =&
  u_{i,\|}
\end{align*}
%
...but time evolution differs...this seems strange
%
\begin{align*}
\partial_t u_{i,\|}
 =&
 - \partial_\|\phi
  %
 - \frac{ 0.51 \nu_{ei} }{ \mu } \L(u_{i,\|}-u_{e,\|}\R)
 \\
 -i\om u_{i,\|}
 =&
 - ik_\|\phi
 =
 -i\om u_{e,\|}
 \\
 k_\|\phi
 =
 \om u_{e,\|}
\end{align*}
%
\begin{align*}
\partial_t u_{e,\|}
 =&
 \mu \partial_\| \L(\phi - T_e  \ln(n)\R)
  %
 - 0.51 \nu_{ei} \L(u_{e,\|}-u_{i,\|}\R)
 \\
 -i\om u_{e,\|}
 =&
 \mu \partial_\| \L(\phi - T_e  \ln(n)\R)
 \\
 =&
 \mu \partial_\| \phi
 - \mu \partial_\| T_e  \ln(n)
 \\
 =&
 i\mu k_\| \phi
 - i\mu k_\| T_e  \ln(n)
 \\
 =&
 i\mu  \om u_{e,\|}
 - i\mu k_\| T_e  \ln(n)
 \\
 -i\om u_{e,\|}
 - i\mu  \om u_{e,\|}
 =&
 - i\mu k_\| T_e  \ln(n)
 \\
 \om u_{e,\|}(1 + \mu)
 =&
 \mu k_\| T_e  \ln(n)
 \\
  u_{e,\|}
 =&
 \frac{\mu k_\| T_e  \ln(n)}{ \om(1 + \mu) }
\end{align*}
%
Insert in the above
%
\begin{align*}
\om
=&
k_\|\frac{\mu k_\| T_e  \ln(n)}{ \om(1 + \mu) }
\\
\om^2
=&
k_\|^2\frac{\mu T_e  \ln(n)}{ 1 + \mu }
\\
\om
=&
k_\|\sqrt{\frac{\mu T_e  \ln(n)}{ 1 + \mu }}
\\
\simeq&
k_\|\sqrt{\ln(n)}
\end{align*}
%
Don't have too big parallel gradients, nor too high $\ln(n)$...also $\ln(n)$ is negative...

% First split
Check small perturbations
drho dtheta
